{% extends 'layout.html.twig' %}

{% block content %}
    <h1>Meme Generator :: Admin</h1>
    <hr>

    <!-- Images -->
    <h2>Images</h2>
    <div id="images">Loading</div>

    <h2>Uploade new image</h2>
    <form action="/api/images" method="post" enctype="multipart/form-data" name="upload_image">
        <input type="file" name="image">
        <input type="submit" value="Upload">
    </form>

    <hr>

    <!-- Memes -->
    <h2>Memes</h2>
    <div id="memes">Loading...</div>

    <h2>New Meme</h2>
    <div id="image-picker">Loading...</div>

    <form action="/api/memes" method="post" name="new_meme">
        <input type="hidden" name="image">

        Top: <input type="text" name="text_top">
        <br>

        Bottom: <input type="text" name="text_bottom">
        <br>

        <input type="submit" value="Create">
    </form>
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
    // Delete image
    function initDeleteImage() {
        $("#image-picker img").click(function(e) {
            var image = $(this);

            // Unselect previously selected image
            $("#image-picker img[data-selected]")
                .css("border", "2px solid #fff")
                .data("selected", 0);

            // Select new image
            image.css("border", "2px solid purple");
            image.data("selected", 1);

            $("form[name=new_meme] input[name=image]").val(image.data("id"));
        });
    }

    function initPicker() {
        $("#images img").click(function(e) {
            if (! confirm("Please confirm you want to delete this image?")) {
                return;
            }

            var image = $(this);
            var id    = image.data("id");

            $.ajax({
                url     : "/api/images/" + id,
                type    : "DELETE",
                success : function() {
                    image.remove();
                }
            })
        });
    }

    // Load images
    $.ajax({
        url    : "/api/images",
        success: function(response) {
            var html;

            // Populate image list
            html = "";
            $.each(response.data, function(i, image) {
                html += '<img src="/images/'+ image.id + '" width="150" data-id="'+ image.id +'">';
            });
            $("#images").html(html);

            // Populate image picker
            html = "";
            $.each(response.data, function(i, image) {
                html += '<img src="/images/'+ image.id + '" width="75" data-id="'+ image.id +'" style="border:2px solid #fff; padding:1px">';
            });
            $("#image-picker").html(html);

            initDeleteImage();
            initPicker();
        }
    });

    // Load memes
    $.ajax({
        url     : "/api/memes",
        success : function(response) {
            if (! response.data.length) {
                $("#memes").html("No memes in the db.");
            } else {
                var html = "";

                $.each(response.data, function(j, meme) {
                    html += '<img src="/memes/'+ meme.id +'" width="200" data-meme-id="'+ meme.id +'">';
                });

                $("#memes").html(html);
            }
        }
    });
    </script>
{% endblock %}